/*
	This plugin is created by Koen Griffioen. Code adapted from the Openseadragon-selection plugin.
	If you need to contact me, please find me on github, KTGLeiden.
*/
!function(a){"use strict";function c(){this.closeMenu()}if(!a.version||a.version.major<2)throw new Error("This version of OpenSeadragonScreenshot requires OpenSeadragon version 2.0.0+");a.Viewer.prototype.screenshot=function(b){return this.screenshotInstance&&!b||(b=b||{},b.viewer=this,this.screenshotInstance=new a.Screenshot(b)),this.screenshotInstance},a.Screenshot=function(b){if(a.extend(!0,this,{viewer:null,buttonActiveImg:!1,screenshotWidth:1e3,screenshotHeight:1e3,showingMenu:!1,makingScreenshot:!1,menuDiv:null,loadingDiv:null,toggleButton:null,navImages:{screenshot:{REST:"selection_rest.png",GROUP:"selection_grouphover.png",HOVER:"selection_hover.png",DOWN:"selection_pressed.png"}},showOptions:!1,showScreenshotControl:!0,keyboardShortcut:null},b),a.extend(!0,this.navImages,this.viewer.navImages),!this.loadingDiv){this.loadingDiv=document.createElement("div"),this.loadingDiv.style.background="rgba(1,1,1, 0.3)";var d=document.createElement("img");d.src=this.viewer.prefixUrl+"ajax_loader_gray_32.gif",d.setAttribute("crossOrigin","anonymous"),this.loadingDiv.style.position="absolute",this.loadingDiv.style.top="0px",this.loadingDiv.style.left="0px",this.loadingDiv.style.width=this.viewer.viewport.containerSize.x+"px",this.loadingDiv.style.height=this.viewer.viewport.containerSize.y+"px",this.loadingDiv.style.backgroundColor="#fff";var e=document.createElement("div");e.appendChild(d),e.style.margin="-16px 0 0 -16px",e.style.position="absolute",e.style.top=Math.round(this.viewer.viewport.containerSize.y/2)+"px",e.style.left=Math.round(this.viewer.viewport.containerSize.x/2)+"px",e.innerHTML+="Loading image... <br>Takes too long?<br>";var f=document.createElement("button");f.onclick=function(){window.location.reload()},f.innerHTML="Refresh page",e.appendChild(f),this.loadingDiv.appendChild(e),document.body.appendChild(this.loadingDiv),this.loadingDiv.className="screenshot-box",this.loadingDiv.style.display="none"}if(this.showOptions&&!this.menuDiv){var g=this.viewer.container,h=document.createElement("div");h.style.position="absolute",h.style.backgroundColor="#f3f3f3",h.style.width="30%",h.style.minWidth="400px",h.style.padding="20px",h.style.margin="-100px 0 0 -200px",h.style.top="50%",h.style.left="50%",h.style.fontFamily="Tahoma,Arial,sans-serif";var i=document.createElement("a");i.style.position="absolute",i.innerHTML="&times;",i.style.position="absolute",i.style.top="20px",i.style.right="30px",i.style.fontSize="30px",i.style.fontWeight="bold",i.style.textDecoration="none",i.style.color="#333",i.style.cursor="pointer",i.id="screenshotCloseButton";var j=document.createElement("p");j.id="screenshotTextMessage",j.display="block";var k=document.createElement("div"),l=[],m=document.createElement("div");m.style.fontSize="20px",m.style.lineHeight="20px",l.push(m);var n=document.createElement("input");n.type="radio",n.name="screenshotForm",n.style.height="25px",n.id="screenshotZFCheck",n.setAttribute("checked",!0),m.appendChild(n),m.innerHTML+="Zoom factor:";var o=document.createElement("input");o.type="range",o.id="screenshotZFInput",o.max="3",o.min="0.25",o.step="0.25",m.appendChild(o);var p=document.createElement("span");p.setAttribute("id","screenshotZFDisplay"),p.setAttribute("value","1"),m.appendChild(p),m.innerHTML+=" times";var m=document.createElement("div");m.style.fontSize="20px",m.style.lineHeight="20px",l.push(m);var q=document.createElement("input");if(q.type="radio",q.style.height="25px",q.id="screenshotUseVpSize",q.name="screenshotForm",m.appendChild(q),m.innerHTML+="Just take a screenshot",this.viewer.annotationInstance){var m=document.createElement("div");l.push(m);var r=document.createElement("input");r.type="checkbox",r.style.height="25px",r.id="screenshotDrawArrows",m.appendChild(r),m.innerHTML+="Also draw annotations"}if(this.viewer.scalebarInstance){var m=document.createElement("div");l.push(m);var s=document.createElement("input");s.type="checkbox",s.style.height="25px",s.id="screenshotDrawScalebar",m.appendChild(s),m.innerHTML+="Draw scalebar as well"}var t=document.createElement("button");t.innerHTML="Download image",t.onclick=this.takeScreenshot.bind(this,t),t.ontouchstart=this.takeScreenshot.bind(this,t),t.style.height="40px",t.style.lineHeight="30px",t.style.fontSize="24px",t.style.margin="0 auto",t.style.display="block";for(var u=l.length-1;u>=0;u--)k.appendChild(l[u]);h.appendChild(i),h.appendChild(k),h.appendChild(j),h.appendChild(t),g.appendChild(h),this.showingMenu=!1,this.menuDiv=h,this.menuDiv.style.display="none",document.getElementById("screenshotZFCheck").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotZFInput").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotZFInput").oninput=this.menuUpdate.bind(this),document.getElementById("screenshotUseVpSize").onchange=this.menuUpdate.bind(this),document.getElementById("screenshotCloseButton").onclick=this.closeMenu.bind(this)}var v=this.prefixUrl||this.viewer.prefixUrl||"",w=this.viewer.buttons&&this.viewer.buttons.buttons,x=w?this.viewer.buttons.buttons[0]:null,y=x?x.onFocus:null,z=x?x.onBlur:null;this.showScreenshotControl&&(this.toggleButton=new a.Button({element:this.toggleButton?a.getElement(this.toggleButton):null,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,tooltip:a.getString("Tooltips.ScreenshotToggle")||"Make Screenshot",srcRest:v+this.navImages.screenshot.REST,srcGroup:v+this.navImages.screenshot.GROUP,srcHover:v+this.navImages.screenshot.HOVER,srcDown:v+this.navImages.screenshot.DOWN,onRelease:this.toggleScreenshotMenu.bind(this),onFocus:y,onBlur:z}),w&&(this.viewer.buttons.buttons.push(this.toggleButton),this.viewer.buttons.element.appendChild(this.toggleButton.element)),this.toggleButton.imgDown&&(this.buttonActiveImg=this.toggleButton.imgDown.cloneNode(!0),this.toggleButton.element.appendChild(this.buttonActiveImg))),this.outerTracker=new a.MouseTracker({element:this.viewer.drawer.canvas,clickTimeThreshold:this.viewer.clickTimeThreshold,clickDistThreshold:this.viewer.clickDistThreshold,clickHandler:a.delegate(this,c),startDisabled:!this.showingMenu})},a.extend(a.Screenshot.prototype,a.ControlDock.prototype,{closeMenu:function(){return this.menuDiv&&(this.menuDiv.style.display="none"),this.showingMenu=!1,this.outerTracker.setTracking(!1),!0},takeScreenshot:function(){var a=!0;this.loadingDiv.style.display="inline";var b=this.viewer.viewport.containerSize,c=b.x,d=b.y,e=this.screenshotWidth,f=this.screenshotHeight;if(this.showOptions){this.viewer.viewport.getMaxZoom(),this.viewer.viewport.getZoom();this.viewer.element.style.height=f+"px",this.viewer.element.style.width=e+"px",this.closeMenu()}var i=this.viewer,j=this.loadingDiv,k=function(){if(i.world.getItemAt(0).removeAllHandlers("fully-loaded-change"),j.style.display="none",a){var b=null;if(i.scalebarInstance&&document.getElementById("screenshotDrawScalebar").checked){var e=i.drawer.canvas;b=document.createElement("canvas"),b.width=e.width,b.height=e.height,console.log(e.width+"/"+e.height);var f=b.getContext("2d");f.drawImage(e,0,0),screenshotDrawArrows&&i.annotationInstance&&i.annotationInstance.drawArrowsOnCanvas(b);var g=i.scalebarInstance.getAsCanvas(),h=i.scalebarInstance.getScalebarLocation();f.drawImage(g,h.x,h.y)}else b=i.drawer.canvas;b.toBlob(function(a){saveAs(a,"screenshot.png"),i.element.style.height=d+"px",i.element.style.width=c+"px"})}};return this.showOptions?requestAnimationFrame(function(){i.forceRedraw(),i.world.getItemAt(0).getFullyLoaded()?k():i.world.getItemAt(0).addHandler("fully-loaded-change",k)}):i.world.getItemAt(0).getFullyLoaded()?k():i.world.getItemAt(0).addHandler("fully-loaded-change",k),!0},toggleScreenshotMenu:function(){return this.showOptions?(this.outerTracker.setTracking(!this.showingMenu),this.showingMenu?(this.closeMenu.bind(this),!0):(this.showMenu(),this.menuUpdate(),!0)):(this.takeScreenshot(),!0)},showMenu:function(){this.menuDiv.style.display="inline",this.showingMenu=!0},menuUpdate:function(){var c=(this.viewer.viewport.containerSize.y/this.viewer.viewport.containerSize.x,document.getElementById("screenshotZFCheck").checked,document.getElementById("screenshotUseVpSize").checked);if(c)this.screenshotWidth=this.viewer.viewport.containerSize.x,this.screenshotHeight=this.viewer.viewport.containerSize.y;else{var d=document.getElementById("screenshotZFInput").value,e=this.viewer.viewport.containerSize.x,f=this.viewer.viewport.containerSize.y;this.screenshotWidth=e*d,this.screenshotHeight=f*d,document.getElementById("screenshotZFDisplay").innerHTML=d}document.getElementById("screenshotTextMessage").innerHTML="Size of download: "+Math.round(this.screenshotWidth)+"x"+Math.round(this.screenshotHeight)}})}(OpenSeadragon);